# OPA/Gatekeeper Constraint Templates â€” FedRAMP Controls
# Deploy to cluster: kubectl apply -f fedramp-constraints.yaml

---
# AC-6: Block privileged containers
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: fedrampnoprivileged
spec:
  crd:
    spec:
      names:
        kind: FedRAMPNoPrivileged
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package fedrampnoprivileged
        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          container.securityContext.privileged == true
          msg := sprintf("FedRAMP AC-6: Container '%v' must not be privileged", [container.name])
        }
        violation[{"msg": msg}] {
          container := input.review.object.spec.initContainers[_]
          container.securityContext.privileged == true
          msg := sprintf("FedRAMP AC-6: Init container '%v' must not be privileged", [container.name])
        }
---
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: FedRAMPNoPrivileged
metadata:
  name: fedramp-no-privileged
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]

---
# CM-6: Require resource limits
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: fedrampresourcelimits
spec:
  crd:
    spec:
      names:
        kind: FedRAMPResourceLimits
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package fedrampresourcelimits
        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not container.resources.limits
          msg := sprintf("FedRAMP CM-6: Container '%v' must define resource limits", [container.name])
        }
        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not container.resources.limits.memory
          msg := sprintf("FedRAMP CM-6: Container '%v' must define memory limit", [container.name])
        }
        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not container.resources.limits.cpu
          msg := sprintf("FedRAMP CM-6: Container '%v' must define CPU limit", [container.name])
        }
---
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: FedRAMPResourceLimits
metadata:
  name: fedramp-resource-limits
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]

---
# AC-6: Require non-root
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: fedramprunasnonroot
spec:
  crd:
    spec:
      names:
        kind: FedRAMPRunAsNonRoot
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package fedramprunasnonroot
        violation[{"msg": msg}] {
          not input.review.object.spec.securityContext.runAsNonRoot
          container := input.review.object.spec.containers[_]
          not container.securityContext.runAsNonRoot
          msg := sprintf("FedRAMP AC-6: Container '%v' must set runAsNonRoot: true", [container.name])
        }
