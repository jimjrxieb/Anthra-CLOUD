# Hardened DVWA Deployment — FedRAMP AC-6, CM-6, SI-2
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dvwa
  namespace: fedramp-demo
  labels:
    app: dvwa
    fedramp-control: AC-6
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dvwa
  template:
    metadata:
      labels:
        app: dvwa
    spec:
      serviceAccountName: dvwa-sa
      automountServiceAccountToken: false
      securityContext:
        runAsNonRoot: true
        runAsUser: 33
        runAsGroup: 33
        fsGroup: 33
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: dvwa
          image: ghcr.io/digininja/dvwa:latest
          ports:
            - containerPort: 80
              protocol: TCP
          env:
            - name: DB_SERVER
              value: mariadb
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: dvwa-db-credentials
                  key: username
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: dvwa-db-credentials
                  key: password
            - name: DB_DATABASE
              value: dvwa
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
              add:
                - NET_BIND_SERVICE
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          readinessProbe:
            httpGet:
              path: /login.php
              port: 80
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /login.php
              port: 80
            initialDelaySeconds: 30
            periodSeconds: 30
---
# MariaDB Database
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mariadb
  namespace: fedramp-demo
  labels:
    app: mariadb
    fedramp-control: AC-6
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mariadb
  template:
    metadata:
      labels:
        app: mariadb
    spec:
      serviceAccountName: dvwa-sa
      automountServiceAccountToken: false
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
        runAsGroup: 999
        fsGroup: 999
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: mariadb
          image: mariadb:10
          ports:
            - containerPort: 3306
              protocol: TCP
          env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: dvwa-db-credentials
                  key: root-password
            - name: MYSQL_DATABASE
              value: dvwa
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  name: dvwa-db-credentials
                  key: username
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: dvwa-db-credentials
                  key: password
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          volumeMounts:
            - name: data
              mountPath: /var/lib/mysql
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: mariadb-data
---
# Database credentials (example — replace with sealed-secrets or external secrets in prod)
apiVersion: v1
kind: Secret
metadata:
  name: dvwa-db-credentials
  namespace: fedramp-demo
  labels:
    fedramp-control: IA-5
type: Opaque
stringData:
  root-password: "CHANGE-ME-root-password"
  username: "dvwa"
  password: "CHANGE-ME-dvwa-password"
---
# PVC for MariaDB data
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mariadb-data
  namespace: fedramp-demo
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
