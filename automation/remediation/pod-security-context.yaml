# Pod Security Context Templates — FedRAMP AC-6
# Hardened security contexts for FedRAMP compliance

---
# PSS Restricted profile — most hardened, FedRAMP target
apiVersion: v1
kind: Pod
metadata:
  name: fedramp-restricted-example
  namespace: fedramp-demo
  labels:
    app: dvwa
    fedramp-control: AC-6
    security-profile: restricted
spec:
  securityContext:
    runAsNonRoot: true
    runAsUser: 33          # www-data for PHP/Apache
    runAsGroup: 33
    fsGroup: 33
    seccompProfile:
      type: RuntimeDefault
  automountServiceAccountToken: false
  containers:
    - name: dvwa
      image: ghcr.io/digininja/dvwa:latest
      securityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: false    # PHP apps need write access
        capabilities:
          drop:
            - ALL
          add:
            - NET_BIND_SERVICE    # Bind to port 80
      resources:
        requests:
          memory: "128Mi"
          cpu: "100m"
        limits:
          memory: "512Mi"
          cpu: "500m"
      ports:
        - containerPort: 80
          protocol: TCP

---
# Deployment patch — apply to existing deployments
# kubectl patch deployment dvwa -n fedramp-demo --patch-file pod-security-patch.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dvwa-security-patch
spec:
  template:
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 33
        runAsGroup: 33
        fsGroup: 33
        seccompProfile:
          type: RuntimeDefault
      automountServiceAccountToken: false
      containers:
        - name: dvwa
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
              add: ["NET_BIND_SERVICE"]
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
