# Policy Check — FedRAMP CM-6, AC-6
# Validates Kubernetes policies with Conftest
name: Policy Check

on:
  push:
    branches: [main]
    paths:
      - 'automation/kubernetes/**'
      - 'automation/policies/**'
      - 'automation/remediation/**'
  pull_request:
    branches: [main]
    paths:
      - 'automation/kubernetes/**'
      - 'automation/policies/**'
      - 'automation/remediation/**'

jobs:
  conftest:
    name: Conftest Policy Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Conftest
        run: |
          CONFTEST_VERSION=0.46.0
          wget -q "https://github.com/open-policy-agent/conftest/releases/download/v${CONFTEST_VERSION}/conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz"
          tar xzf "conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz"
          sudo mv conftest /usr/local/bin/

      - name: Validate Kubernetes manifests against FedRAMP controls
        run: |
          echo "=== FedRAMP Policy Validation ==="
          conftest test automation/kubernetes/*.yaml \
            --policy automation/policies/conftest/ \
            --all-namespaces

  kyverno-lint:
    name: Kyverno Policy Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Kyverno CLI
        run: |
          curl -LO https://github.com/kyverno/kyverno/releases/latest/download/kyverno-cli_v1.12.0_linux_x86_64.tar.gz || true
          tar xzf kyverno-cli_v1.12.0_linux_x86_64.tar.gz 2>/dev/null || echo "Kyverno CLI download skipped"

      - name: Validate Kyverno policies
        run: |
          if command -v kyverno &> /dev/null; then
            kyverno validate automation/policies/kyverno/
          else
            echo "Kyverno CLI not available — validating YAML syntax only"
            for f in automation/policies/kyverno/*.yaml; do
              python3 -c "import yaml; yaml.safe_load(open('$f'))" && echo "OK: $f" || echo "FAIL: $f"
            done
          fi
